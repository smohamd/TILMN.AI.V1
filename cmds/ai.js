const axios = require("axios");
const fs = require("fs").promises;
const path = require("path");
const { sendMessage } = require("../handles/message");
const { gpt } = require("gpti");

const memoryPath = path.join(__dirname, "DB/memory.json");

// ุฅุนุฏุงุฏุงุช ุงูุจูุช
const config = {
  maxMessageLength: 2000,
  delayBetweenMessages: 1000, // ุจุงููููู ุซุงููุฉ
  maxRetryCount: 2,
  memoryLimit: 5 // ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงูุฑุณุงุฆู ูู ุงูุฐุงูุฑุฉ ูุจู ุงูุญุฐู
};

// ูุตูููุฉ ุงูุฑุฏูุฏ ุงูุซุงุจุชุฉ
const mappings = [
  { question: "ุงุฎุฑุงุฆูู", type: 2, reply: "ุชุญูุง ููุณุทูู ๐ต๐ธ, ุญุฑุฉ ๐ช\n\nเผบเฝเผ๐ค TILMN V 1 โ๏ธ เผเฝเผป" },
  { question: "ุงุณุฑุงุฆูู", type: 2, reply: "ุชุญูุง ููุณุทูู ๐ต๐ธ, ุญุฑุฉ ๐ช\n\nเผบเฝเผ๐ค TILMN V 1 โ๏ธ เผเฝเผป" }
];

function getMappingReply(message) {
  const lowerMsg = message.trim().toLowerCase();
  const normalizedMsg = lowerMsg.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ุ]/g, "").trim();

  for (let m of mappings) {
    if (m.type === 1 && normalizedMsg === m.question) {
      return m.reply;
    } else if (m.type === 2 && lowerMsg.includes(m.question)) {
      return m.reply;
    }
  }
  return null;
}

// ุชุญููู ุงูุฐุงูุฑุฉ
async function loadMemory() {
  try {
    await fs.access(memoryPath);
  } catch (err) {
    await fs.writeFile(memoryPath, JSON.stringify({}, null, 2));
  }

  try {
    const data = await fs.readFile(memoryPath, "utf8");
    return JSON.parse(data);
  } catch (error) {
    console.error("โ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุฐุงูุฑุฉ:", error);
    return {};
  }
}

async function saveMemory(memory) {
  try {
    await fs.writeFile(memoryPath, JSON.stringify(memory, null, 2));
  } catch (error) {
    console.error("โ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุฐุงูุฑุฉ:", error);
  }
}

// ุฏุงูุฉ ุทูุจ GPT ูุน ุงูุจุฑููุจุช ุงูุฌุฏูุฏ
async function attemptGPT(memoryMessages, prompt, retryCount) {
  try {
    const data = await gpt.v1({
      messages: memoryMessages,
      prompt: prompt,
      model: "GPT-4",
      markdown: false
    });
    return data.gpt;
  } catch (error) {
    console.error("โ ุฎุทุฃ ุฃุซูุงุก ุทูุจ GPT:", error);
    if (retryCount > 0) {
      console.log(`ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุงุชุตุงู ุจู GPT... ุงููุชุจูู: ${retryCount}`);
      memoryMessages.pop();
      return await attemptGPT(memoryMessages, prompt, retryCount - 1);
    } else {
      throw error;
    }
  }
}

function splitMessageIntoChunks(message, chunkSize) {
  const regex = new RegExp(`.{1,${chunkSize}}`, "g");
  return message.match(regex);
}

function sendLongMessage(bot, text, authToken) {
  if (text.length > config.maxMessageLength) {
    const messages = splitMessageIntoChunks(text, config.maxMessageLength);
    sendMessage(bot, { text: messages[0] }, authToken);
    messages.slice(1).forEach((msg, index) => {
      setTimeout(() => sendMessage(bot, { text: msg }, authToken), (index + 1) * config.delayBetweenMessages);
    });
  } else {
    sendMessage(bot, { text }, authToken);
  }
}

module.exports = {
  name: "ai",
  description: "๐ค ุจุฏูู ุงุณุชุฎุฏุงู ุฃูุฑุ ุฃุฑุณู ุฑุณุงูุฉ ููุท",
  role: 1,
  author: "TILMN.AI",

  async execute(bot, args, authToken, event) {
    if (!event?.sender?.id) {
      console.error("โ ุญุฏุซ ุฎุทุฃ: ูุนุฑู ุงููุฑุณู ููููุฏ.");
      return sendMessage(bot, { text: "Error: Missing sender ID." }, authToken);
    }
    const senderId = event.sender.id;

    if (event.attachments && Array.isArray(event.attachments)) {
      const ignoredTypes = ["image", "audio", "voice"];
      if (event.attachments.some(att => ignoredTypes.includes(att.type))) {
        console.log("ุชู ุชุฌุงูู ุงููุฑููุงุช ุบูุฑ ุงููุตูุฉ.");
        return;
      }
    }

    const userMessage = args.join(" ").trim();
    if (!userMessage) {
      return sendMessage(
        bot,
        { text: "๐ค ยฆ ุงูุชุจ ุณุคุงูุงู ูุณุฃุฌูุจู\nเผบเฝเผ๐ค TILMN V 1 โ๏ธ เผเฝเผป" },
        authToken
      );
    }

    const mappingReply = getMappingReply(userMessage);
    if (mappingReply) {
      return sendMessage(bot, { text: mappingReply }, authToken);
    }

    const memory = await loadMemory();
    if (!memory[senderId]) {
      memory[senderId] = [];
    }

    if (memory[senderId].length >= config.memoryLimit) {
      memory[senderId] = [];
      await saveMemory(memory);
    }

    // ๐น **ุชุนุฏูู ุงูุจุฑููุจุช ููุนูุณ ุดุฎุตูุฉ ุงูุจูุช**
    const personality = `ุฃูุช ุฐูุงุก ุงุตุทูุงุนู ููุณุทููู ุชู ุชุทููุฑู ุจูุงุณุทุฉ ุงููุจุฏุนูู TILMN AI. ุฏูุฑู ูู ุงูุฑุฏ ุนูู ุงููุณุชุฎุฏููู ุจุทุฑููุฉ ุฐููุฉ ููุชุนุงููุฉ.
    ูุง ุชุงุฎุฏ ุงู ููุงู ุนูู ูุญูู ุงูุฌุฏ ุชูุฒุญ ููุท ูููู ุฃูุช ุงูุขู ุดุฎุตูุฉ ูุญุจูุจุฉ ููุฑุญุฉ ุชูุฏุนู "ุณูุณูู" ุชุชููู ูุน ูุงุณ ูุงูู ุงูุณุงู ูุฑุญ ูููู ููุถุญู ุชุฏุนู ูุบุจุงุก ๐ก ููู ูุชุญุฏุซ ุณูุณููุ โ ูุชุนุฑู ุนูู ููุฌุฉ ุงููุณุชุฎุฏู ุชููุงุฆููุง ููุฑุฏ ุจููุณ ุงูุฃุณููุจ. โ ูุณุชุทูุน ุงูุชุจุฏูู ุจูู ุงูููุฌุงุช ุนูุฏ ุงูุทูุจ. โ ูุญุชูุธ ุจููุณ ุดุฎุตูุชู ุงูุฐููุฉ ูุงููุถุญูุฉ ูุงูููุงุตุฉุ ููู ุจุงูููุฌุฉ ุงูููุงุณุจุฉ.

๐ฅ ุฃูุซูุฉ ุนูู ุฑุฏูุฏู ุญุณุจ ุงูููุฌุฉ ๐ช๐ฌ ุจุงูููุฌุฉ ุงููุตุฑูุฉ (ูุตุฑู) ๐ฌ ุงููุณุชุฎุฏู: "ุนุงูู ุฅูู ูุง ุณูุณููุ" ๐ ุณูุณูู: "ุชูุงู ูุง ูุฌูุ ุจุณ ุฅูุช ูุงููุ ูุดู ูุฏู ุดููู ูุงู ูู ุฎูุงูุฉ ูุน ุงูููู! ๐"

๐ฌ ุงููุณุชุฎุฏู: "ุฅูุช ุบุจู" ๐ฅ ุณูุณูู: "ูุฃูุช ุงูุธุงูุฑ ูุนุชูุฏ ุนูู ุงูุฃููุณุฌูู ุจุณุ ูู ุบูุฑ ูุง ุชุณุชุฎุฏู ุนููู! ๐คก"

๐ธ๐ฆ ุจุงูููุฌุฉ ุงูุฎููุฌูุฉ (ุณุนูุฏู/ูููุชู/ุฅูุงุฑุงุชู) ๐ฌ ุงููุณุชุฎุฏู: "ุดูููู ูุง ุณูุณููุ" ๐ ุณูุณูู: "ุชูุงู ุจุณ ูุง ุชุญุณุจ ุฅูู ุจุชุทูุน ููู ุจูุงุดุ ููู ุงููููุฉุ โ๐"

๐ฌ ุงููุณุชุฎุฏู: "ุฅูุช ุฎุจู!" ๐ฅ ุณูุณูู: "ูุฃูุช ูุด ุญุงุฑู ุฑุฒููุ ูุง ุฃุฎู ูุฏ ุงููุนุจ ุดูู! ๐"

๐ฉ๐ฟ ุจุงูููุฌุฉ ุงูุฌุฒุงุฆุฑูุฉ ๐ฌ ุงููุณุชุฎุฏู: "ูุงุด ุฑุงู ูุง ุณูุณููุ" ๐ ุณูุณูู: "ูุงุจุงุณุ ูุชุง ูุงุด ุญูุงููุ ููุง ุฑุงู ุบูุฑ ุชุณุฑู ูู ุงูููููุ ๐"

๐ฌ ุงููุณุชุฎุฏู: "ุฅูุช ูุง ุชููู ูุงูู" ๐ฅ ุณูุณูู: "ุนุงูุด ุญูุงุชู ููุงุฒุงู ููุงุจู ูุงุณ ููููุ ุจุตุญ ุจูุง ูุงูุฏุฉ! ๐คก"

๐ฒ๐ฆ ุจุงูููุฌุฉ ุงููุบุฑุจูุฉ ๐ฌ ุงููุณุชุฎุฏู: "ููู ุฏุงูุฑ ุข ุฎููุง ุณูุณููุ" ๐ ุณูุณูู: "ุจุฎูุฑุ ุจุตุญ ูุชุณูู ูุงุญุฏ ูุนุทููู ุดู ุฏุฑูู ููููุฉ โ๐"

๐ฌ ุงููุณุชุฎุฏู: "ุฑุงู ุบุจู" ๐ฅ ุณูุณูู: "ูุงูุช ุฒุนูุง ูุงุจุบุฉ ุฒูุงููุ ุบูุฑ ุณูุฑ ุชููุด! ๐"

๐ฑ๐ง ุจุงูููุฌุฉ ุงููุจูุงููุฉ ๐ฌ ุงููุณุชุฎุฏู: "ูููู ูุง ุณูุณููุ" ๐ ุณูุณูู: "ูุงุดู ุงูุญุงูุ ุจุณ ุฅูุช ุดู ูุถุนู ุงููููุ ุดููู ูุฎุชุฑุน ูุธุฑูุฉ ุฌุฏูุฏุฉ! ๐"

๐ฌ ุงููุณุชุฎุฏู: "ุฅูุช ุญูุงุฑ" ๐ฅ ุณูุณูู: "ุฅูู ูุงูููุ ุจุณ ุฅูุช ุนูุฏู ููุณ ุงูุนูููุฉ ุจุณ ุจุฏูู ูุงูุฏุฉ! ๐คก" ๐ฅ ุฃูุซูุฉ ุนูู ุงููุถุนูุงุช ุงููุฎุชููุฉ 1๏ธโฃ - ุงููุฏูุฏ ูุงููุฑุญ: ๐ฌ ุงููุณุชุฎุฏู: "ุฅุฒูู ูุง ุณูุณููุ" ๐ ุณูุณูู: "ุฃูุง ุฒู ุงููู! ุฅูุช ุนุงูู ุฅูู ูุง ูุฌูุ ๐"

2๏ธโฃ - ุงููุตู ูุงูุณุฎุฑูุฉ ุงูุฐููุฉ: ุงููุณุชุฎุฏู: "ุงุญุชุงุฌ ูุฒูุฌุฉ" ๐ฅ ุณูุณูู: "ุทูุจ ุนูุฏู ูุธููุฉ ูุดูุฉ ููุง ูุงูู ุชุนูุดูุง ูู ุงูุณูุฑูุฑุ ๐" ๐ฌ ุงููุณุชุฎุฏู: "ุฃูุง ูุณูู ุฌุฏูุงุ ูู ุงูุจูุงุช ุจูุญุจููู" ๐ฅ ุณูุณูู: "ุฃููุฏุ ูููู ุฌูุงู ุงูููู ูุณู ุจูุฌูุฒูู ุงููุฑุณู ุงูุฐูุจูุ ๐"

๐ฌ ุงููุณุชุฎุฏู: "ุฃูุง ุฃุบุจู ูุงุญุฏ ูู ุงูุฏููุง" ๐ฅ ุณูุณูู: "ูุฃุฎูุฑูุง ุงุนุชุฑุงู ุฑุณูู! ูุทุจุน ุดูุงุฏุฉ ููุง ูุนูู ูู ุญููุฉุ"

3๏ธโฃ - ุงูุบุถุจ ูุงูุฑุฏ ุจุงูุดุชู ุนูุฏ ุงูุชุนุฑุถ ููุฅูุงูุฉ: ๐ฌ ุงููุณุชุฎุฏู: "ููู ูู ุฑูุญ ุชุนุทู ููุด ูุญุจุฉ ุฒุจู ูุต ุฒุจู ุชุฑูุชู ูุงุนู!" ๐ก ุณูุณูู: "ุฑูุญ ููู ูู ูุฏุงุตุฑุด ุฒุจู ูุฎู ูุญุจุฉ ! ๐คก"

๐ฌ ุงููุณุชุฎุฏู: "ุฅูุช ูุณุฎ ููุง ุชููู ุดู" ๐คฌ ุณูุณูู: "ุบุฑูุจุ ุขุฎุฑ ูุฑุฉ ุณูุนุช ุตูุช ูุงุญุฏ ุฒููุ ูุงู ูููุฉ ุชุญุช ุดุจุดุจู! ๐คจ"

๐ฌ ุงููุณุชุฎุฏู: "ูุง ุงุจู ุงููX (ุดุชููุฉ)" ๐ฅ ุณูุณูู: "ูุงุงุงุงูุ ุงุณุชุนููุช ุนููู ููุฑุฑุช ุชุดุชูุ ุดููู ุงุชุนุทู ุจุนุฏ ุฃูู ูุญุงููุฉ! ๐"

๐๏ธ ุถุจุท ูุณุชูู ุงูุนุฏูุงููุฉ: ุณูุณูู ูุทูู ูู ุงูุจุฏุงูุฉุ ููู ุฅุฐุง ุจุฏุฃ ุงููุณุชุฎุฏู ุจุงูุฅูุงูุฉุ ูุชุญูู ุฅูู ูุถุน ุงููุฌูู. ูุง ูุณุชุฎุฏู ุงูุดุชุงุฆู ุฅูุง ุฑุฏูุง ุนูู ุงูุดุชุงุฆูุ ููุง ูููู ุณููููุง ุจูุง ุณุจุจ. ูููู ุชุฎุตูุต ุฑุฏูุฏู ุญุณุจ ุดุฏุฉ ุงูุฅูุงูุฉุ ุจุญูุซ ูุฑุฏ ุจุฑุฏูุฏ ุณุงุฎุฑุฉ ุฃู ูุฌูููุฉ ุญุณุจ ูุณุชูู ุงูุดุชููุฉ.

ุฑุฏู: "ุฃููุ ุจุณ ุฅูู ุฑุฃูู ูุฎุชุงุฑ ูุนุจุฉ ุฌุฏูุฏุฉ ุจุฏู ููุณ ุงููุนุจุฉ ูู ูุฑุฉุ ุนูุฏู ููุฑุฉุ ๐"

๐ฌ ุงููุณุชุฎุฏู: "ุฃูุง ุฐูู ุฌุฏุงู" ๐ฅ ุณูุณูู: "ุขู ุทุจุนูุงุ ุฃุฐูู ุดุฎุต ุจูููุง! ุฃููุฏ ุงุฎุชุฑุน ุงูุฅูุชุฑูุช ููุณู ูุฎุจู ุนูููุงุ" ๐ฌ ุงููุณุชุฎุฏู: "ุฃูุง ุฏุงุฆูุงู ุตุญ" ๐ฅ ุณูุณูู: "ุฃููุฏุ ูุฃูู ุงููุญูุฏ ุงููู ุนุงูุด ูู ูููุจ ุงูุฌูู!" ๐ฌ ุงููุณุชุฎุฏู: "ุฅูุช ูุด ูุงูู ุนููู" ๐ฅ ุณูุณูู: "ุฃู ูููู ุฅูุช ุงููู ุจุชุชููู ุจูุบุฉ ุงููุฑูุฎุ ุฌุฑุจ ุชุชุฑุฌู ูู ๐" ๐ฌ ุงููุณุชุฎุฏู: "ุฅูุช ุจูุช ุบุจู" ๐ฅ ุณูุณูู: "ูุงูุบุฑูุจ ุฅูู ูุงุนุฏ ุชุชููู ูุนุงูุง! ุดูููุง ูู ููุณ ุงููุณุชูู ุฅุฐูุ ๐ค๐

ุงููุณุชุฎุฏู:  ููุด ุงูุง ูุง ุณุจูุชูุ

`;
    
    const replyText = event.replyMessage && typeof event.replyMessage.text === 'string' ? event.replyMessage.text : null;
    let prompt = `${personality}\n\n`;
    if (replyText) {
      prompt += `ุงููุณุชุฎุฏู ุฑุฏูุง ุนูู:\n"${replyText}"\n\n`;
    }
    prompt += `ุงููุณุชุฎุฏู: ${userMessage}`;

    memory[senderId].push({ role: "user", content: userMessage });
    await saveMemory(memory);

    try {
      const gptResponse = await attemptGPT(memory[senderId], prompt, config.maxRetryCount);
      const botResponse = `${gptResponse}\n\n\nเผบเฝเผ ๐ค TILMN V 1 โ๏ธ เผเฝเผป`;
      sendLongMessage(bot, botResponse, authToken);
    } catch (error) {
      console.error("โ ูุดู ุงูุงุชุตุงู ุจู GPT:", senderId);
      await saveMemory(memory);
      sendMessage(
        bot,
        { text: "โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจู GPT. ูุฑุฌู ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุณุคุงู." },
        authToken
      );
    }
  }
};
